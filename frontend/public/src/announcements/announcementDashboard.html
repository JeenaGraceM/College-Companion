<!DOCTYPE html>
<html>
<head>
    <title>Role-Based Dashboard</title>
    <style>
        /* Global styling */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #FFE082; /* Soft yellow */
            color: #333;
        }

        h1 {
            background-color: #64B5F6; /* Blue header */
            color: white;
            text-align: center;
            padding: 20px;
            margin: 0;
            font-size: 2rem;
            letter-spacing: 1px;
        }

        h2 {
            color: #444;
            margin-bottom: 10px;
            text-align: center;
        }

        /* Section cards */
        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            padding: 15px;
            margin: 15px auto;
            width: 85%;
            max-width: 700px;
        }

        /* Role selector */
        select {
            display: block;
            margin: 20px auto;
            padding: 10px;
            font-size: 1rem;
            border: 2px solid #64B5F6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        /* Buttons */
        button {
            background-color: #FF894F; /* Orange */
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #E57373; /* Pinkish red hover */
            transform: scale(1.05);
        }

        input, textarea {
            width: 95%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        textarea {
            resize: vertical;
        }
    </style>
</head>
<body>
    <h1>College Companion Portal</h1>

    <!-- Role selector -->
    <select id="roleSelect" onchange="loadDashboard()">
        <option value="">-- Select Role --</option>
        <option value="student">Student</option>
        <option value="rep">Class Representative</option>
        <option value="teacher">Teacher</option>
    </select>

    <!-- Dashboard -->
    <div id="dashboard"></div>

    <script>
        const API_URL = "http://localhost:5000/api/announcements"; 
        let currentUser = {
            id: "689ae92cef93efa1a5eec4aa",
            role: ""
        };

        // Load announcements from backend
        async function loadAnnouncements() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                let html = `<h3>Announcements</h3>`;
                
                if (data.length === 0) {
                    html += `<p>No announcements yet.</p>`;
                } else {
                    data.forEach(a => {
                        html += `<div style="border-bottom: 1px solid #eee; padding: 10px 0; margin-bottom: 15px;">
                            <p style="margin: 5px 0;"><strong>${a.title}</strong></p>
                            <p style="margin: 5px 0;">${a.content}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                Posted by: ${a.posted_by?.fullName || a.posted_by_role} 
                                on ${new Date(a.createdAt).toLocaleString()}
                            </p>`;
                        
                        if (a.fileUrl) {
                            const fileUrl = `http://localhost:5000${a.fileUrl}`;
                            html += `<p style="margin: 10px 0;">
                                <a href="${fileUrl}" target="_blank" style="color: #2196F3; text-decoration: none; margin-right: 15px;">
                                    üìÑ View PDF
                                </a>
                                <a href="${fileUrl}" download style="color: #4CAF50; text-decoration: none;">
                                    ‚¨áÔ∏è Download PDF
                                </a>
                            </p>`;
                        }
                        html += `</div>`;
                    });
                }
                document.getElementById("announcementsSection").innerHTML = html;
            } catch (err) {
                console.error('Error loading announcements:', err);
                document.getElementById("announcementsSection").innerHTML = 
                    `<p style="color: red;">Error loading announcements: ${err.message}</p>`;
            }
        }

        // Post new announcement
        async function postAnnouncement() {
            const title = document.getElementById("title").value;
            const content = document.getElementById("content").value;
            const file = document.getElementById("fileUpload").files[0];

            if (!title || !content) {
                alert("Please fill in both title and content");
                return;
            }

            const formData = new FormData();
            formData.append("title", title.trim());
            formData.append("content", content.trim());
            formData.append("posted_by", currentUser.id.trim());
            formData.append("posted_by_role", currentUser.role.trim());
            
            if (file) {
                if (file.type !== 'application/pdf') {
                    alert("Please upload only PDF files");
                    return;
                }
                formData.append("file", file);
            }

            // Log FormData contents for debugging
            console.log("FormData contents:");
            for (let [key, value] of formData.entries()) {
                console.log(key + ": " + (value instanceof File ? value.name : value));
            }

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: formData
                    // Don't set Content-Type header for FormData - let browser set it automatically
                });

                console.log("Response status:", res.status);
                
                let result;
                try {
                    result = await res.json();
                } catch (parseError) {
                    console.error("Error parsing response:", parseError);
                    throw new Error("Server returned invalid response");
                }

                if (res.ok) {
                    alert("Announcement posted successfully!");
                    // Clear form fields
                    document.getElementById("title").value = "";
                    document.getElementById("content").value = "";
                    document.getElementById("fileUpload").value = "";
                    // Reload announcements
                    loadAnnouncements();
                } else {
                    console.error("Server error:", result);
                    alert("Error posting announcement: " + (result.error || "Unknown error"));
                }
            } catch (err) {
                console.error('Network error:', err);
                alert("Network error: " + err.message);
            }
        }

        // View engagement data (for teachers)
        async function viewEngagement() {
            try {
                const res = await fetch(`${API_URL}/engagement`);
                const data = await res.json();
                
                let html = `<h3>Engagement Data</h3>`;
                html += `<p><strong>Total Announcements:</strong> ${data.totalAnnouncements}</p>`;
                
                html += `<p><strong>Announcements by Role:</strong></p>`;
                html += `<ul>`;
                data.announcementsByRole.forEach(role => {
                    html += `<li>${role._id}: ${role.count}</li>`;
                });
                html += `</ul>`;
                
                html += `<p><strong>Recent Activity:</strong></p>`;
                html += `<ul>`;
                data.recentActivity.forEach(announcement => {
                    html += `<li>${announcement.title} - by ${announcement.posted_by?.fullName || announcement.posted_by_role}</li>`;
                });
                html += `</ul>`;
                
                let engagementSection = document.getElementById("engagementSection");
                if (!engagementSection) {
                    engagementSection = document.createElement("div");
                    engagementSection.id = "engagementSection";
                    engagementSection.className = "section";
                    document.getElementById("dashboard").appendChild(engagementSection);
                }
                engagementSection.innerHTML = html;
                
            } catch (err) {
                console.error('Error loading engagement data:', err);
                alert("Error loading engagement data");
            }
        }

        // Load dashboard UI
        function loadDashboard() {
            const role = document.getElementById("roleSelect").value;
            currentUser.role = role;
            if (!role) {
                document.getElementById("dashboard").innerHTML = "";
                return;
            }

            let html = `<h2>${role.toUpperCase()} Dashboard</h2>`;

            html += `<div class="section" id="announcementsSection"></div>`;

            if (role === "rep") {
                html += `<div class="section"><h3>Rep Actions</h3>
                    <input type="text" id="title" placeholder="Announcement Title" /><br>
                    <textarea id="content" placeholder="Write announcement..." rows="4"></textarea><br>
                    <input type="file" id="fileUpload" accept=".pdf" /><br>
                    <small>Only PDF files are allowed</small><br><br>
                    <button onclick="postAnnouncement()">Post Announcement</button>
                </div>`;
            }

            if (role === "teacher") {
                html += `<div class="section"><h3>Teacher Actions</h3>
                    <input type="text" id="title" placeholder="Announcement Title" /><br>
                    <textarea id="content" placeholder="Write announcement..." rows="4"></textarea><br>
                    <input type="file" id="fileUpload" accept=".pdf" /><br>
                    <small>Only PDF files are allowed</small><br><br>
                    <button onclick="postAnnouncement()">Post Announcement</button>
                    <button onclick="viewEngagement()">View Engagement</button>
                </div>`;
            }

            document.getElementById("dashboard").innerHTML = html;
            loadAnnouncements();
        }
    </script>
</body>
</html>
